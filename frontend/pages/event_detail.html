<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Details - PicMe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes fade-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-fade-in { animation: fade-in 0.5s ease-in-out forwards; }
    </style>
</head>
<body class="bg-gray-50">
    <nav class="bg-white/90 backdrop-blur-md border-b border-gray-200 shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <a href="/homepage" class="flex items-center space-x-2">
                    <svg class="w-8 h-8 text-indigo-600" viewBox="0 0 32 32" fill="currentColor"><path d="M16 2L20 10H28L22 16L24 24L16 20L8 24L10 16L4 10H12L16 2Z"/><circle cx="16" cy="16" r="6" fill="none" stroke="currentColor" stroke-width="2"/></svg>
                    <span class="text-xl font-bold text-indigo-600">PicMe</span>
                </a>
                <div class="hidden md:flex items-center space-x-8">
                    <a href="/homepage" class="text-gray-600 hover:text-indigo-600">Home</a>
                    <a href="/event_discovery" class="text-gray-600 hover:text-indigo-600">Events</a>
                    <a href="/personal_photo_gallery" class="text-gray-600 hover:text-indigo-600">My Photos</a>
                    <a href="/my_downloads" class="text-gray-600 hover:text-indigo-600">My Downloads</a>
                    <a href="/my_reviews" class="text-gray-600 hover:text-indigo-600">My Reviews</a>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/logout" class="px-4 py-2 rounded-md text-sm font-medium text-red-600 border border-red-600 hover:bg-red-50">Logout</a>
                </div>
            </div>
        </div>
    </nav>

    <main class="pt-24 pb-12 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-12">
            <p id="event-category" class="text-sm font-semibold text-indigo-600 uppercase tracking-wider"></p>
            <h1 id="event-name" class="text-4xl font-bold text-gray-900 mt-2">Loading Event...</h1>
            <p id="event-date" class="text-lg text-gray-600 mt-2"></p>
            
            <!-- Privacy Notice -->
            <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4 max-w-2xl mx-auto">
                <div class="flex items-start">
                    <svg class="w-5 h-5 text-blue-600 mt-0.5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                    </svg>
                    <div class="text-left">
                        <p class="text-sm font-medium text-blue-900">Privacy Protected</p>
                        <p class="text-sm text-blue-700 mt-1">Only group photos are shown publicly. Scan your face to access your individual photos securely.</p>
                    </div>
                </div>
            </div>
            
            <a id="scan-face-link" href="#" class="mt-6 inline-block px-8 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors">
                üîí Scan My Face to See My Individual Photos
            </a>
        </div>

        <!-- Group Photos Section -->
        <div class="border-t border-gray-200 pt-10 mb-10">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-900">Group Photos</h2>
                <span id="group-photo-count" class="text-sm text-gray-600"></span>
            </div>
            <div id="loading-message" class="text-center text-gray-500 py-8">Loading photos...</div>
            <div id="group-photos-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            </div>
            <!-- Download Selected Button -->
            <div id="download-selected-container" class="mt-6 flex items-center justify-between bg-gray-50 p-4 rounded-lg hidden">
                <span id="selected-count" class="text-gray-700 font-medium">0 photos selected</span>
                <button id="download-selected-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-6 py-3 rounded-lg flex items-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    <span>Download Selected</span>
                </button>
            </div>
        </div>

        <!-- Individual Photos Section (Hidden until face scan) -->
        <div id="individual-photos-section" class="border-t border-gray-200 pt-10 hidden">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-900">Your Individual Photos</h2>
                <span id="individual-photo-count" class="text-sm text-gray-600"></span>
            </div>
            <div id="individual-photos-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            </div>
        </div>

        <!-- Your Group Photos Section (Hidden until face scan) -->
        <div id="my-group-photos-section" class="border-t border-gray-200 pt-10 hidden">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-900">Group Photos With You</h2>
                <span id="my-group-photo-count" class="text-sm text-gray-600"></span>
            </div>
            <div id="my-group-photos-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            </div>
        </div>

        <!-- Reviews Section -->
        <div class="border-t border-gray-200 pt-16 mt-16">
            <div class="max-w-4xl mx-auto">
                <div class="text-center mb-12">
                    <h2 class="text-3xl font-bold text-gray-900 mb-4">Event Reviews</h2>
                    <p class="text-lg text-gray-600">See what attendees are saying about this event</p>
                </div>
                
                <div id="event-reviews-container" class="space-y-6 mb-8">
                    <!-- Reviews will be loaded here -->
                    <div class="text-center text-gray-500 py-8">
                        Loading reviews...
                    </div>
                </div>
                
                <div class="text-center space-y-4">
                    <!-- Scan QR Code Button -->
                    <div id="scan-qr-section">
                        <p class="text-gray-600 mb-3">Want to review this event? Scan the event QR code first!</p>
                        <a id="scan-qr-link" href="#" class="inline-block px-6 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition-colors">
                            üì± Scan Event QR Code
                        </a>
                    </div>
                    
                    <!-- Write Review Button (shown after QR scan) -->
                    <div id="write-review-section" class="hidden">
                        <button id="write-review-btn-event" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors">
                            ‚úçÔ∏è Write Event Review
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Review Modal -->
    <div id="review-modal-event" class="hidden fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-md w-full p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-gray-900">Write a Review</h3>
                <button id="close-review-modal-event" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <form id="review-form-event">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Rating</label>
                    <div class="flex space-x-2">
                        <button type="button" class="star-btn-event text-3xl text-gray-300 hover:text-yellow-400 transition-colors" data-rating="1">‚òÖ</button>
                        <button type="button" class="star-btn-event text-3xl text-gray-300 hover:text-yellow-400 transition-colors" data-rating="2">‚òÖ</button>
                        <button type="button" class="star-btn-event text-3xl text-gray-300 hover:text-yellow-400 transition-colors" data-rating="3">‚òÖ</button>
                        <button type="button" class="star-btn-event text-3xl text-gray-300 hover:text-yellow-400 transition-colors" data-rating="4">‚òÖ</button>
                        <button type="button" class="star-btn-event text-3xl text-gray-300 hover:text-yellow-400 transition-colors" data-rating="5">‚òÖ</button>
                    </div>
                    <input type="hidden" id="rating-input-event" name="rating" required>
                </div>
                
                <div class="mb-4">
                    <label for="review-text-event" class="block text-sm font-medium text-gray-700 mb-2">Your Review</label>
                    <textarea id="review-text-event" name="review_text" rows="4" required minlength="10" maxlength="500"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                              placeholder="Share your experience with PicMe..."></textarea>
                    <p class="text-xs text-gray-500 mt-1">Minimum 10 characters, maximum 500 characters</p>
                </div>
                
                <div id="review-error-event" class="text-red-600 text-sm mb-4 hidden"></div>
                <div id="review-success-event" class="text-green-600 text-sm mb-4 hidden"></div>
                
                <div class="flex space-x-3">
                    <button type="submit" class="flex-1 bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors">
                        Submit Review
                    </button>
                    <button type="button" id="cancel-review-event" class="flex-1 bg-gray-200 text-gray-700 font-semibold px-4 py-2 rounded-lg hover:bg-gray-300 transition-colors">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Photo Lightbox Modal -->
    <div id="photo-lightbox" class="hidden fixed inset-0 z-50 bg-black/90 flex items-center justify-center">
        <!-- Close Button -->
        <button id="close-lightbox" class="absolute top-4 right-4 text-white hover:text-gray-300 transition-colors z-10">
            <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
        
        <!-- Previous Button -->
        <button id="prev-photo" class="absolute left-4 top-1/2 transform -translate-y-1/2 text-white hover:text-gray-300 transition-colors z-10">
            <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
        </button>
        
        <!-- Next Button -->
        <button id="next-photo" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-white hover:text-gray-300 transition-colors z-10">
            <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
        </button>
        
        <!-- Image Container -->
        <div class="flex items-center justify-center w-full h-full p-4">
            <img id="lightbox-image" src="" class="max-w-full max-h-full object-contain" alt="Photo preview">
        </div>
        
        <!-- Download Button -->
        <div class="absolute bottom-8 left-1/2 transform -translate-x-1/2 flex items-center space-x-4">
            <button id="download-photo-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-8 py-3 rounded-lg shadow-lg transition-all flex items-center space-x-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                </svg>
                <span>Download Photo</span>
            </button>
            <div id="download-status" class="text-white text-sm hidden"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const eventId = urlParams.get('event_id');
            const eventNameEl = document.getElementById('event-name');
            const eventDateEl = document.getElementById('event-date');
            const eventCategoryEl = document.getElementById('event-category');
            const scanLink = document.getElementById('scan-face-link');
            const groupGrid = document.getElementById('group-photos-grid');
            const loadingMessage = document.getElementById('loading-message');
            const groupPhotoCount = document.getElementById('group-photo-count');

            if (!eventId) {
                eventNameEl.textContent = "Event Not Found";
                loadingMessage.textContent = "No event ID provided in the URL.";
                return;
            }

            scanLink.href = `/biometric_authentication_portal?event_id=${eventId}`;
            
            // Set QR scanner link with event_id
            const scanQrLink = document.getElementById('scan-qr-link');
            if (scanQrLink) {
                scanQrLink.href = `/qr_scanner?event_id=${eventId}`;
            }

            // Load event details
            try {
                const eventResponse = await fetch(`/api/events/${eventId}`);
                const data = await eventResponse.json();
                if (data.success) {
                    const currentEvent = data.event;
                    eventNameEl.textContent = currentEvent.name;
                    eventCategoryEl.textContent = currentEvent.category || 'General';
                    eventDateEl.textContent = new Date(currentEvent.date).toLocaleDateString('en-US', {
                        year: 'numeric', month: 'long', day: 'numeric'
                    });
                } else {
                    eventNameEl.textContent = "Event Not Found";
                }
            } catch (error) {
                console.error("Could not load event details:", error);
                eventNameEl.textContent = "Error Loading Event";
            }
            
            // Load GROUP photos only (public access)
            try {
                const photosResponse = await fetch(`/api/events/${eventId}/photos`);
                const data = await photosResponse.json();
                if (data.success && data.photos.length > 0) {
                    loadingMessage.style.display = 'none';
                    groupPhotoCount.textContent = `${data.photos.length} photos`;
                    groupGrid.innerHTML = data.photos.map((photoUrl, idx) => 
                        `<div class="opacity-0 animate-fade-in relative">
                            <!-- Checkbox for selection -->
                            <input type="checkbox" 
                                   class="photo-checkbox absolute top-2 left-2 w-5 h-5 z-10 cursor-pointer rounded"
                                   data-photo-url="${photoUrl}"
                                   data-photo-index="${idx}">
                            <!-- Photo -->
                            <img src="${photoUrl}" 
                                 class="w-full h-64 object-cover rounded-lg shadow-md hover:shadow-xl transition-shadow cursor-pointer photo-thumbnail" 
                                 data-photo-url="${photoUrl}"
                                 data-photo-index="${idx}"
                                 loading="lazy" 
                                 alt="Group photo">
                        </div>`
                    ).join('');
                    
                    // Make photos clickable after loading
                    setTimeout(() => makePhotosClickable(), 100);
                } else {
                    loadingMessage.textContent = 'No photos have been processed for this event yet.';
                }
            } catch (error) {
                console.error("Could not load event photos:", error);
                loadingMessage.textContent = 'Failed to load photos. The server may be down.';
            }

            // Check if user has already scanned their face for this event
            checkForMyPhotos();

            async function checkForMyPhotos() {
                try {
                    const myPhotosResponse = await fetch(`/api/events/${eventId}/my-photos`);
                    const data = await myPhotosResponse.json();
                    
                    if (data.success) {
                        // User has scanned their face - show their individual photos
                        displayMyPhotos(data);
                    }
                    // If not successful, user hasn't scanned yet - that's fine
                } catch (error) {
                    // User hasn't scanned yet or error occurred - that's fine
                }
            }

            function displayMyPhotos(data) {
                const individualSection = document.getElementById('individual-photos-section');
                const myGroupSection = document.getElementById('my-group-photos-section');
                const individualGrid = document.getElementById('individual-photos-grid');
                const myGroupGrid = document.getElementById('my-group-photos-grid');
                const individualCount = document.getElementById('individual-photo-count');
                const myGroupCount = document.getElementById('my-group-photo-count');

                // Show individual photos
                if (data.individual_photos && data.individual_photos.length > 0) {
                    individualSection.classList.remove('hidden');
                    individualCount.textContent = `${data.individual_photos.length} photos`;
                    individualGrid.innerHTML = data.individual_photos.map((photoUrl, idx) => 
                        `<div class="opacity-0 animate-fade-in relative">
                            <input type="checkbox" 
                                   class="photo-checkbox absolute top-2 left-2 w-5 h-5 z-10 cursor-pointer rounded"
                                   data-photo-url="${photoUrl}"
                                   data-photo-index="${idx}">
                            <img src="${photoUrl}" 
                                 class="w-full h-64 object-cover rounded-lg shadow-md hover:shadow-xl transition-shadow cursor-pointer photo-thumbnail" 
                                 data-photo-url="${photoUrl}"
                                 data-photo-index="${idx}"
                                 loading="lazy" 
                                 alt="Your individual photo">
                        </div>`
                    ).join('');
                }

                // Show group photos where user appears
                if (data.group_photos && data.group_photos.length > 0) {
                    myGroupSection.classList.remove('hidden');
                    myGroupCount.textContent = `${data.group_photos.length} photos`;
                    myGroupGrid.innerHTML = data.group_photos.map((photoUrl, idx) => 
                        `<div class="opacity-0 animate-fade-in relative">
                            <input type="checkbox" 
                                   class="photo-checkbox absolute top-2 left-2 w-5 h-5 z-10 cursor-pointer rounded"
                                   data-photo-url="${photoUrl}"
                                   data-photo-index="${idx}">
                            <img src="${photoUrl}" 
                                 class="w-full h-64 object-cover rounded-lg shadow-md hover:shadow-xl transition-shadow cursor-pointer photo-thumbnail" 
                                 data-photo-url="${photoUrl}"
                                 data-photo-index="${idx}"
                                 loading="lazy" 
                                 alt="Group photo with you">
                        </div>`
                    ).join('');
                }

                // Update scan button
                scanLink.innerHTML = '‚úÖ Face Scanned - View Updated Photos';
                scanLink.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                scanLink.classList.add('bg-green-600', 'hover:bg-green-700');
                
                // Make photos clickable after loading
                setTimeout(() => makePhotosClickable(), 100);
            }

            // Listen for face scan completion (from biometric portal)
            window.addEventListener('storage', (e) => {
                if (e.key === `face_scanned_${eventId}`) {
                    checkForMyPhotos();
                    // Re-enable lightbox after face scan
                    setTimeout(() => makePhotosClickable(), 200);
                }
            });

            // Photo Lightbox Functionality
            const lightbox = document.getElementById('photo-lightbox');
            const lightboxImage = document.getElementById('lightbox-image');
            const closeLightboxBtn = document.getElementById('close-lightbox');
            const prevPhotoBtn = document.getElementById('prev-photo');
            const nextPhotoBtn = document.getElementById('next-photo');
            const downloadPhotoBtn = document.getElementById('download-photo-btn');
            const downloadStatus = document.getElementById('download-status');
            
            let currentPhotos = [];
            let currentPhotoIndex = 0;
            let currentEventName = '';

            function openLightbox(photos, index, eventName) {
                currentPhotos = photos;
                currentPhotoIndex = index;
                currentEventName = eventName;
                updateLightboxImage();
                lightbox.classList.remove('hidden');
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
            }

            function closeLightbox() {
                lightbox.classList.add('hidden');
                document.body.style.overflow = ''; // Restore scrolling
                downloadStatus.classList.add('hidden');
            }

            function updateLightboxImage() {
                lightboxImage.src = currentPhotos[currentPhotoIndex];
                
                // Update navigation buttons visibility
                prevPhotoBtn.style.display = currentPhotoIndex > 0 ? 'block' : 'none';
                nextPhotoBtn.style.display = currentPhotoIndex < currentPhotos.length - 1 ? 'block' : 'none';
            }

            function showNextPhoto() {
                if (currentPhotoIndex < currentPhotos.length - 1) {
                    currentPhotoIndex++;
                    updateLightboxImage();
                }
            }

            function showPrevPhoto() {
                if (currentPhotoIndex > 0) {
                    currentPhotoIndex--;
                    updateLightboxImage();
                }
            }

            // Event listeners for lightbox controls
            closeLightboxBtn.addEventListener('click', closeLightbox);
            nextPhotoBtn.addEventListener('click', showNextPhoto);
            prevPhotoBtn.addEventListener('click', showPrevPhoto);
            
            // Close on background click
            lightbox.addEventListener('click', (e) => {
                if (e.target === lightbox) {
                    closeLightbox();
                }
            });
            
            // Keyboard navigation
            document.addEventListener('keydown', (e) => {
                if (!lightbox.classList.contains('hidden')) {
                    if (e.key === 'Escape') closeLightbox();
                    else if (e.key === 'ArrowRight') showNextPhoto();
                    else if (e.key === 'ArrowLeft') showPrevPhoto();
                }
            });

            // Download functionality
            downloadPhotoBtn.addEventListener('click', async () => {
                const photoUrl = currentPhotos[currentPhotoIndex];
                
                // Show loading state
                downloadPhotoBtn.disabled = true;
                downloadPhotoBtn.innerHTML = `
                    <svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    <span>Downloading...</span>
                `;
                
                try {
                    // Trigger browser download
                    const link = document.createElement('a');
                    link.href = photoUrl;
                    link.download = photoUrl.split('/').pop();
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // Track download in database
                    const response = await fetch('/api/download-photo', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            photo_url: photoUrl,
                            event_id: eventId,
                            event_name: currentEventName
                        })
                    });
                    
                    const data = await response.json();
                    
                    // Show success message
                    downloadStatus.textContent = data.already_downloaded ? 
                        '‚úì Already in your downloads' : 
                        '‚úì Added to your downloads';
                    downloadStatus.classList.remove('hidden');
                    setTimeout(() => downloadStatus.classList.add('hidden'), 3000);
                    
                } catch (error) {
                    console.error('Download error:', error);
                    downloadStatus.textContent = '‚úó Download failed';
                    downloadStatus.classList.remove('hidden');
                    setTimeout(() => downloadStatus.classList.add('hidden'), 3000);
                } finally {
                    // Restore button state
                    downloadPhotoBtn.disabled = false;
                    downloadPhotoBtn.innerHTML = `
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        <span>Download Photo</span>
                    `;
                }
            });

            // Helper function to download a photo
            async function downloadPhotoDirectly(photoUrl) {
                try {
                    // Trigger browser download
                    const link = document.createElement('a');
                    link.href = photoUrl;
                    link.download = photoUrl.split('/').pop();
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // Track download in database
                    await fetch('/api/download-photo', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            photo_url: photoUrl,
                            event_id: eventId,
                            event_name: eventNameEl.textContent
                        })
                    });
                    
                    console.log('Photo downloaded and tracked:', photoUrl);
                } catch (error) {
                    console.error('Download error:', error);
                }
            }

            // Make photos clickable to open lightbox
            window.makePhotosClickable = function() {
                console.log('Making photos clickable...');
                // Get event name for download tracking
                currentEventName = eventNameEl.textContent;
                
                // Helper function to add click handlers
                function addClickHandlers(container) {
                    if (!container) return;
                    
                    const photoContainers = container.querySelectorAll('.relative.group');
                    console.log(`Adding handlers for ${photoContainers.length} photo containers`);
                    
                    photoContainers.forEach((photoContainer, index) => {
                        const img = photoContainer.querySelector('.photo-thumbnail');
                        if (!img) return;
                        
                        const photoUrl = img.dataset.photoUrl || img.src;
                        const allPhotos = Array.from(container.querySelectorAll('.photo-thumbnail')).map(i => i.dataset.photoUrl || i.src);
                        
                        // Make image clickable
                        img.style.cursor = 'pointer';
                        img.addEventListener('click', (e) => {
                            // Only open lightbox if not clicking on download button
                            if (!e.target.classList.contains('download-btn') && !e.target.closest('.download-btn')) {
                                console.log('Photo clicked:', photoUrl);
                                openLightbox(allPhotos, index, currentEventName);
                            }
                        });
                        
                        // Make download button work
                        const downloadBtn = photoContainer.querySelector('.download-btn');
                        if (downloadBtn) {
                            downloadBtn.addEventListener('click', async (e) => {
                                e.stopPropagation();
                                e.preventDefault();
                                console.log('Download button clicked:', photoUrl);
                                await downloadPhotoDirectly(photoUrl);
                            });
                        }
                    });
                }
                
                // Group photos (public)
                addClickHandlers(groupGrid);
                
                // Individual photos (after face scan)
                const individualGrid = document.getElementById('individual-photos-grid');
                if (individualGrid) {
                    addClickHandlers(individualGrid);
                }
                
                // My group photos (after face scan)
                const myGroupGrid = document.getElementById('my-group-photos-grid');
                if (myGroupGrid) {
                    addClickHandlers(myGroupGrid);
                }
                
                console.log('Photos clickable setup complete');
            };
            // Selection tracking
            let selectedPhotos = new Set();
            const downloadSelectedContainer = document.getElementById('download-selected-container');
            const selectedCountEl = document.getElementById('selected-count');
            const downloadSelectedBtn = document.getElementById('download-selected-btn');

            // Update selection UI
            function updateSelectionUI() {
                const count = selectedPhotos.size;
                selectedCountEl.textContent = `${count} photo${count !== 1 ? 's' : ''} selected`;
                downloadSelectedBtn.disabled = count === 0;
                downloadSelectedContainer.classList.toggle('hidden', count === 0);
            }

            // Handle checkbox changes
            function setupCheckboxHandlers() {
                document.querySelectorAll('.photo-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        e.stopPropagation();
                        const photoUrl = checkbox.dataset.photoUrl;
                        if (checkbox.checked) {
                            selectedPhotos.add(photoUrl);
                        } else {
                            selectedPhotos.delete(photoUrl);
                        }
                        updateSelectionUI();
                    });
                });
            }

            // Download selected photos
            downloadSelectedBtn.addEventListener('click', async () => {
                if (selectedPhotos.size === 0) return;
                
                downloadSelectedBtn.disabled = true;
                downloadSelectedBtn.innerHTML = '<span>Downloading...</span>';
                
                for (const photoUrl of selectedPhotos) {
                    await downloadPhotoDirectly(photoUrl);
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                selectedPhotos.clear();
                document.querySelectorAll('.photo-checkbox:checked').forEach(cb => cb.checked = false);
                updateSelectionUI();
                
                downloadSelectedBtn.innerHTML = `
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    <span>Download Selected</span>
                `;
            });

            // Override makePhotosClickable to work with new structure
            const originalMakePhotosClickable = window.makePhotosClickable;
            window.makePhotosClickable = function() {
                console.log('Setting up photo clicks and checkboxes...');
                currentEventName = eventNameEl.textContent;
                
                // Get all photos
                const allPhotos = Array.from(document.querySelectorAll('.photo-thumbnail')).map(img => img.dataset.photoUrl || img.src);
                
                // Make images clickable
                document.querySelectorAll('.photo-thumbnail').forEach((img, index) => {
                    img.addEventListener('click', (e) => {
                        if (e.target.type === 'checkbox') return;
                        console.log('Photo clicked, opening lightbox');
                        openLightbox(allPhotos, index, currentEventName);
                    });
                });
                
                // Setup checkboxes
                setupCheckboxHandlers();
                
                console.log('Setup complete');
            };

            // Check if user has scanned QR for this event
            async function checkEventAttendance() {
                try {
                    const response = await fetch(`/api/check-event-attendance?event_id=${eventId}`);
                    const data = await response.json();
                    
                    if (data.has_scanned) {
                        // User has scanned QR - show write review button
                        document.getElementById('scan-qr-section').classList.add('hidden');
                        document.getElementById('write-review-section').classList.remove('hidden');
                    }
                } catch (error) {
                    console.log('Could not check attendance status');
                }
            }

            // Load event-specific reviews
            async function loadReviews() {
                try {
                    const response = await fetch(`/api/reviews/event/${eventId}`);
                    const data = await response.json();
                    
                    const container = document.getElementById('event-reviews-container');
                    
                    if (!data.success || data.reviews.length === 0) {
                        container.innerHTML = '<div class="text-center text-gray-500 py-8">No reviews yet. Be the first to review this event!</div>';
                        return;
                    }
                    
                    container.innerHTML = data.reviews.map(review => `
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex items-center">
                                    <div class="w-12 h-12 bg-indigo-600 rounded-full flex items-center justify-center text-white font-semibold text-lg">
                                        ${review.user_name.charAt(0).toUpperCase()}
                                    </div>
                                    <div class="ml-3">
                                        <p class="font-semibold text-gray-900">${review.user_name}</p>
                                        <p class="text-sm text-gray-500">${new Date(review.created_at).toLocaleDateString()}</p>
                                    </div>
                                </div>
                                <div class="flex text-yellow-400 text-lg">
                                    ${'‚òÖ'.repeat(review.rating)}${'‚òÜ'.repeat(5 - review.rating)}
                                </div>
                            </div>
                            <p class="text-gray-700">${review.review_text}</p>
                        </div>
                    `).join('');
                    
                } catch (error) {
                    console.error('Error loading reviews:', error);
                    document.getElementById('event-reviews-container').innerHTML = 
                        '<div class="text-center text-gray-500 py-8">Failed to load reviews</div>';
                }
            }

            // Review modal functionality
            const reviewModal = document.getElementById('review-modal-event');
            const writeReviewBtn = document.getElementById('write-review-btn-event');
            const closeReviewModal = document.getElementById('close-review-modal-event');
            const cancelReview = document.getElementById('cancel-review-event');
            const reviewForm = document.getElementById('review-form-event');
            const ratingInput = document.getElementById('rating-input-event');
            const starBtns = document.querySelectorAll('.star-btn-event');
            const reviewError = document.getElementById('review-error-event');
            const reviewSuccess = document.getElementById('review-success-event');
            
            let selectedRating = 0;

            // Star rating functionality
            starBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    selectedRating = parseInt(btn.dataset.rating);
                    ratingInput.value = selectedRating;
                    
                    starBtns.forEach((star, index) => {
                        if (index < selectedRating) {
                            star.classList.remove('text-gray-300');
                            star.classList.add('text-yellow-400');
                        } else {
                            star.classList.remove('text-yellow-400');
                            star.classList.add('text-gray-300');
                        }
                    });
                });
            });

            // Open review modal
            writeReviewBtn.addEventListener('click', async () => {
                try {
                    const response = await fetch('/api/reviews/user');
                    const data = await response.json();
                    
                    if (response.status === 401) {
                        alert('Please log in to write a review');
                        window.location.href = '/login';
                        return;
                    }
                    
                    // Pre-fill if user has existing review
                    if (data.success && data.review) {
                        selectedRating = data.review.rating;
                        ratingInput.value = selectedRating;
                        document.getElementById('review-text-event').value = data.review.review_text;
                        
                        starBtns.forEach((star, index) => {
                            if (index < selectedRating) {
                                star.classList.remove('text-gray-300');
                                star.classList.add('text-yellow-400');
                            }
                        });
                    }
                    
                    reviewModal.classList.remove('hidden');
                } catch (error) {
                    alert('Please log in to write a review');
                    window.location.href = '/login';
                }
            });

            // Close modal
            closeReviewModal.addEventListener('click', () => {
                reviewModal.classList.add('hidden');
                reviewForm.reset();
                selectedRating = 0;
                starBtns.forEach(star => {
                    star.classList.remove('text-yellow-400');
                    star.classList.add('text-gray-300');
                });
                reviewError.classList.add('hidden');
                reviewSuccess.classList.add('hidden');
            });

            cancelReview.addEventListener('click', () => {
                closeReviewModal.click();
            });

            // Submit review
            reviewForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                reviewError.classList.add('hidden');
                reviewSuccess.classList.add('hidden');
                
                if (!selectedRating) {
                    reviewError.textContent = 'Please select a rating';
                    reviewError.classList.remove('hidden');
                    return;
                }
                
                const reviewText = document.getElementById('review-text-event').value.trim();
                
                if (reviewText.length < 10) {
                    reviewError.textContent = 'Review must be at least 10 characters long';
                    reviewError.classList.remove('hidden');
                    return;
                }
                
                try {
                    const response = await fetch('/api/reviews', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            rating: selectedRating,
                            review_text: reviewText,
                            event_id: eventId,  // Include event ID for event-specific review
                            is_general_review: false  // This is an event review
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        reviewSuccess.textContent = data.message;
                        reviewSuccess.classList.remove('hidden');
                        
                        setTimeout(() => {
                            closeReviewModal.click();
                            loadReviews(); // Reload reviews
                        }, 1500);
                    } else {
                        reviewError.textContent = data.error || 'Failed to submit review';
                        reviewError.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error('Error submitting review:', error);
                    reviewError.textContent = 'Failed to submit review. Please try again.';
                    reviewError.classList.remove('hidden');
                }
            });

            // Load reviews and check attendance on page load
            loadReviews();
            checkEventAttendance();
        });
    </script>
</body>
</html>